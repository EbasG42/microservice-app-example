name: CI - Build and Push Docker Images

on:
  push:
    branches:
      - master

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Lista de servicios para construir
      - name: Build and push Auth API
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./dockerfiles/dockerfile.authApi
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/auth-api:latest

      - name: Build and push Users API
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./dockerfiles/dockerfile.usersApi
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/users-api:latest

      - name: Build and push Todos API
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./dockerfiles/dockerfile.todoApi
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/todos-api:latest

      - name: Build and push Log Processor
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./dockerfiles/dockerfile.log-message
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/log-message-processor:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./dockerfiles/dockerfile.frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/frontend:latest

      - name: Setup Kubeconfig
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest' 

      - name: Deploy to Kubernetes (CD)
        env:
          KUBECONFIG: ${{ secrets.KUBE_CONFIG }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
          # Usamos el SHA del commit como tag para las im치genes
          NEW_TAG: ${{ github.sha }} 
        run: |
          # 1. Almacena la configuraci칩n de Minikube en un archivo temporal
          echo "$KUBECONFIG" > ./kubeconfig.yaml
          export KUBECONFIG=./kubeconfig.yaml

          # 2. Reemplazar la imagen en todos los manifiestos de Deployment
          echo "Aplicando tag $NEW_TAG a los manifiestos..."
          
          # Sustituci칩n de im치genes (cambiando 'dockerfiles-auth-api' por la imagen de Docker Hub)
          sed -i "s|image: dockerfiles-auth-api|image: $DOCKER_USER/auth-api:$NEW_TAG|g" k8s/manifests/05-auth-api.yaml
          sed -i "s|image: dockerfiles-users-api|image: $DOCKER_USER/users-api:$NEW_TAG|g" k8s/manifests/04-users-api.yaml
          sed -i "s|image: dockerfiles-auth-api|image: $DOCKER_USER/auth-api:$NEW_TAG|g" k8s/manifests/06-todos-api.yaml
          sed -i "s|image: dockerfiles-auth-api|image: $DOCKER_USER/auth-api:$NEW_TAG|g" k8s/manifests/07-log-processor-api.yaml
          sed -i "s|image: dockerfiles-auth-api|image: $DOCKER_USER/auth-api:$NEW_TAG|g" k8s/manifests/08-frontend-api.yaml            
          # 3. Aplicar los manifiestos actualizados para forzar un rolling update
          echo "Aplicando manifiestos actualizados..."
          kubectl apply -f k8s/ -n microservices

          echo "Despliegue Continuo (CD) completado."
